@model AssetManagementSystem.DAL.Entities.Asset
@{
    ViewData["Title"] = "Create Asset";
    Layout = "~/Views/Shared/_Dashboard.cshtml";
}

<div class="container mt-4">
    <div class="card shadow-lg rounded-4 border-0">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h3 class="mb-0"><i class="bi bi-box-seam me-2"></i> Create New Asset</h3>
        </div>

        <div class="card-body">
            <form asp-action="Create" method="post" id="createAssetForm" class="needs-validation" novalidate>
                <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>

                <!-- Asset Identification Section -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="bi bi-tag me-2"></i> Asset Identification</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="AssetTag" class="form-label">Asset Tag <span class="text-danger">*</span></label>
                                <input asp-for="AssetTag" class="form-control" required />
                                <span asp-validation-for="AssetTag" class="text-danger"></span>
                                <div class="form-text">Unique identifier for this asset</div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label asp-for="AssetDescription" class="form-label">Description</label>
                                <input asp-for="AssetDescription" class="form-control" />
                                <span asp-validation-for="AssetDescription" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label asp-for="AssetClass1" class="form-label">Asset Class 1</label>
                                <input asp-for="AssetClass1" class="form-control" />
                                <span asp-validation-for="AssetClass1" class="text-danger"></span>
                            </div>

                            <div class="col-md-4 mb-3">
                                <label asp-for="AssetClass2" class="form-label">Asset Class 2</label>
                                <input asp-for="AssetClass2" class="form-control" />
                                <span asp-validation-for="AssetClass2" class="text-danger"></span>
                            </div>

                            <div class="col-md-4 mb-3">
                                <label asp-for="AssetClass3" class="form-label">Asset Class 3</label>
                                <input asp-for="AssetClass3" class="form-control" />
                                <span asp-validation-for="AssetClass3" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Location Section -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="bi bi-geo-alt me-2"></i> Location Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="FacilityId" class="form-label">Facility <span class="text-danger">*</span></label>
                                <select asp-for="FacilityId" class="form-select" asp-items="ViewBag.Facilities" required id="facilitySelect">
                                    <option value="">-- Select Facility --</option>
                                </select>
                                <span asp-validation-for="FacilityId" class="text-danger"></span>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label asp-for="DepartmentId" class="form-label">Department <span class="text-danger">*</span></label>
                                <select asp-for="DepartmentId" class="form-select" asp-items="ViewBag.Departments" required>
                                    <option value="">-- Select Department --</option>
                                </select>
                                <span asp-validation-for="DepartmentId" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label asp-for="BuildingId" class="form-label">Building <span class="text-danger">*</span></label>
                                <select asp-for="BuildingId" class="form-select" required id="buildingSelect">
                                    <option value="">-- Select Building --</option>
                                </select>
                                <span asp-validation-for="BuildingId" class="text-danger"></span>
                            </div>

                            <div class="col-md-4 mb-3">
                                <label asp-for="FloorId" class="form-label">Floor <span class="text-danger">*</span></label>
                                <select asp-for="FloorId" class="form-select" required id="floorSelect">
                                    <option value="">-- Select Floor --</option>
                                </select>
                                <span asp-validation-for="FloorId" class="text-danger"></span>
                            </div>

                            <div class="col-md-4 mb-3">
                                <label asp-for="RoomTag" class="form-label">Room</label>
                                <select asp-for="RoomTag" class="form-select" id="roomSelect">
                                    <option value="">-- Select Room --</option>
                                </select>
                                <span asp-validation-for="RoomTag" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Technical Details Section -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="bi bi-gear me-2"></i> Technical Details</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label asp-for="Brand" class="form-label">Brand</label>
                                <input asp-for="Brand" class="form-control" />
                                <span asp-validation-for="Brand" class="text-danger"></span>
                            </div>

                            <div class="col-md-4 mb-3">
                                <label asp-for="Model" class="form-label">Model</label>
                                <input asp-for="Model" class="form-control" />
                                <span asp-validation-for="Model" class="text-danger"></span>
                            </div>

                            <div class="col-md-4 mb-3">
                                <label asp-for="SerialNumber" class="form-label">Serial Number</label>
                                <input asp-for="SerialNumber" class="form-control" />
                                <span asp-validation-for="SerialNumber" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="AssetType" class="form-label">Asset Type</label>
                                <select asp-for="AssetType" class="form-select" asp-items="ViewBag.AssetTypes">
                                    <option value="">-- Select Asset Type --</option>
                                </select>
                                <span asp-validation-for="AssetType" class="text-danger"></span>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label asp-for="Status" class="form-label">Status</label>
                                <select asp-for="Status" class="form-select" asp-items="ViewBag.StatusOptions">
                                    <option value="">-- Select Status --</option>
                                </select>
                                <span asp-validation-for="Status" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label asp-for="Details" class="form-label">Additional Details</label>
                                <textarea asp-for="Details" class="form-control" rows="3"></textarea>
                                <span asp-validation-for="Details" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="d-flex justify-content-between">
                    <a asp-action="Index" class="btn btn-secondary">
                        <i class="bi bi-arrow-left"></i> Back to List
                    </a>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-plus-circle"></i> Create Asset
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
                 $(document).ready(function() {
            console.log("Document ready - initializing asset creation form");

            // Initialize form validation
            (() => {
                'use strict'
                const forms = document.querySelectorAll('.needs-validation')
                Array.from(forms).forEach(form => {
                    form.addEventListener('submit', event => {
                        if (!form.checkValidity()) {
                            event.preventDefault()
                            event.stopPropagation()
                        }
                        form.classList.add('was-validated')
                    }, false)
                })
            })()

            // Handle facility change
            $('#facilitySelect').change(function() {
                const facilityId = $(this).val();
                console.log("Facility selected:", facilityId);

                if (facilityId) {
                    // Clear dependent dropdowns
                    $('#buildingSelect').empty().append('<option value="">-- Select Building --</option>').prop('disabled', true);
                    $('#floorSelect').empty().append('<option value="">-- Select Floor --</option>').prop('disabled', true);
                    $('#roomSelect').empty().append('<option value="">-- Select Room --</option>').prop('disabled', true);

                    // Load buildings
                    $.ajax({
                           url: "/Asset/GetBuildingsByFacilityAsync",
        data: { facilityId: facilityId },
        type: 'GET',
        dataType: 'json',
                        success: function(data) {
                            console.log("Buildings data received:", data);
                            if (data && data.length > 0) {
                                $('#buildingSelect').prop('disabled', false);
                                $.each(data, function(index, item) {
                                    $('#buildingSelect').append(
                                        `<option value="${item.id}">${item.name}</option>`
                                    );
                                });
                            } else {
                                console.log("No buildings found for facility:", facilityId);
                            }
                        },
                        error: function(xhr, status, error) {
                            console.error("Error loading buildings:", error);
                            console.error("Status:", xhr.status);
                            console.error("Response text:", xhr.responseText);
                        }
                    });
                }
            });

            // Handle building change
            $('#buildingSelect').change(function() {
                const buildingId = $(this).val();
                console.log("Building selected:", buildingId);

                if (buildingId) {
                    // Clear floor and room dropdowns
                    $('#floorSelect').empty().append('<option value="">-- Select Floor --</option>').prop('disabled', true);
                    $('#roomSelect').empty().append('<option value="">-- Select Room --</option>').prop('disabled', true);

                    $.ajax({
                        url: "/Asset/GetFloorsByBuildingAsync",
                        data: { buildingId: buildingId },
                        type: 'GET',
                        dataType: 'json',
                        success: function(data) {
                            console.log("Floors data received:", data);
                            if (data && data.length > 0) {
                                $('#floorSelect').prop('disabled', false);
                                $.each(data, function(index, item) {
                                    $('#floorSelect').append(
                                        `<option value="${item.id}">${item.name}</option>`
                                    );
                                });
                            } else {
                                console.log("No floors found for building:", buildingId);
                            }
                        },
                        error: function(xhr, status, error) {
                            console.error("Error loading floors:", error);
                            console.error("Status:", xhr.status);
                            console.error("Response text:", xhr.responseText);
                        }
                    });
                }
            });

            // Handle floor change
            $('#floorSelect').change(function() {
                const floorId = $(this).val();
                console.log("Floor selected:", floorId);

                if (floorId) {
                    // Clear room dropdown
                    $('#roomSelect').empty().append('<option value="">-- Select Room --</option>').prop('disabled', true);

                    $.ajax({
                        url: "/Asset/GetRoomsByFloorAsync",
                        data: { floorId: floorId },
                        type: 'GET',
                        dataType: 'json',
                        success: function(data) {
                            console.log("Rooms data received:", data);
                            if (data && data.length > 0) {
                                $('#roomSelect').prop('disabled', false);
                                $.each(data, function(index, item) {
                                    $('#roomSelect').append(
                                        `<option value="${item.roomTag}">${item.name}</option>`
                                    );
                                });
                            } else {
                                console.log("No rooms found for floor:", floorId);
                            }
                        },
                        error: function(xhr, status, error) {
                            console.error("Error loading rooms:", error);
                            console.error("Status:", xhr.status);
                            console.error("Response text:", xhr.responseText);
                        }
                    });
                }
            });
        });
    </script>
}