@model IEnumerable<AssetManagementSystem.DAL.Entities.Asset>

@{
    ViewData["Title"] = "الأصول";
    Layout = "~/Views/Shared/_Dashboard.cshtml";
}

<!-- Asset Overview Section with Cards -->
<div class="container-fluid mb-4">
    <div class="row asset-summary-cards">
        <div class="col-md-3 mb-3">
            <div class="card bg-gradient-primary text-white shadow-lg h-100 border-0 rounded-4 zoom-on-hover">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="text-white">إجمالي الأصول</h5>
                            <h2 class="display-5 fw-bold text-white" id="totalAssetCount">--</h2>
                        </div>
                        <div class="icon-circle bg-white">
                            <i class="fas fa-boxes fa-2x text-primary"></i>
                        </div>
                    </div>
                    <p class="mt-2 mb-0">كافة الأصول المسجلة في النظام</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card bg-gradient-success text-white shadow-lg h-100 border-0 rounded-4 zoom-on-hover">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="text-white">الأصول النشطة</h5>
                            <h2 class="display-5 fw-bold text-white" id="activeAssetCount">--</h2>
                        </div>
                        <div class="icon-circle bg-white">
                            <i class="fas fa-check-circle fa-2x text-success"></i>
                        </div>
                    </div>
                    <p class="mt-2 mb-0">الأصول الحالية قيد الاستخدام</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card bg-gradient-warning text-white shadow-lg h-100 border-0 rounded-4 zoom-on-hover">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="text-white">قيد الصيانة</h5>
                            <h2 class="display-5 fw-bold text-white" id="maintenanceAssetCount">--</h2>
                        </div>
                        <div class="icon-circle bg-white">
                            <i class="fas fa-tools fa-2x text-warning"></i>
                        </div>
                    </div>
                    <p class="mt-2 mb-0">الأصول تحت الصيانة أو الإصلاح</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card bg-gradient-danger text-white shadow-lg h-100 border-0 rounded-4 zoom-on-hover">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="text-white">تم التكهين</h5>
                            <h2 class="display-5 fw-bold text-white" id="disposedAssetCount">--</h2>
                        </div>
                        <div class="icon-circle bg-white">
                            <i class="fas fa-trash-alt fa-2x text-danger"></i>
                        </div>
                    </div>
                    <p class="mt-2 mb-0">الأصول التي تم تكهينها</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions Bar -->
<div class="card shadow-lg rounded-4 mb-4 border-0">
    <div class="card-body p-2">
        <div class="d-flex justify-content-between align-items-center flex-wrap">
            <div class="d-flex align-items-center">
                <h4 class="text-primary mb-0 ms-2"><i class="fas fa-bolt"></i> عمليات سريعة</h4>
            </div>
            <div class="quick-actions">
                <a asp-action="Create" class="btn btn-primary rounded-pill">
                    <i class="fas fa-plus-circle"></i> إضافة أصل
                </a>
                <button class="btn btn-info rounded-pill" data-bs-toggle="modal" data-bs-target="#importModal">
                    <i class="fas fa-file-import"></i> استيراد
                </button>
                <div class="btn-group">
                    <button class="btn btn-success rounded-pill dropdown-toggle" data-bs-toggle="dropdown">
                        <i class="fas fa-file-export"></i> تصدير
                    </button>
                    <ul class="dropdown-menu">
                        <li><a href="@Url.Action("ExportAssets", "Asset")" class="dropdown-item"><i class="fas fa-file-excel text-success me-2"></i> Excel</a></li>
                        <li><a href="@Url.Action("ExportAssetsToPdf", "Asset")" class="dropdown-item"><i class="fas fa-file-pdf text-danger me-2"></i> PDF</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- TabPane for Operations and Search -->
<div class="card shadow-lg border-0 rounded-4 mb-4">
    <div class="card-header bg-white p-0 rounded-top-4">
        <ul class="nav nav-tabs nav-fill border-0" id="assetTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active rounded-0 py-3" id="bulk-tab" data-bs-toggle="tab" data-bs-target="#bulk-operations" type="button" role="tab">
                    <i class="fas fa-layer-group me-2"></i> العمليات المجمعة
                </button>
            </li>
         
            <li class="nav-item" role="presentation">
                <button class="nav-link rounded-0 py-3" id="tags-tab" data-bs-toggle="tab" data-bs-target="#asset-tags" type="button" role="tab">
                    <i class="fas fa-tags me-2"></i> البحث بواسطة Tags
                </button>
            </li>
        </ul>
    </div>
    <div class="card-body p-4">
        <div class="tab-content" id="assetTabsContent">
            <!-- Bulk Operations Tab -->
            <div class="tab-pane fade show active" id="bulk-operations" role="tabpanel">
                <div class="row align-items-center">
                    <div class="col-md-9">
                        <div class="d-flex gap-3 flex-wrap">
                            <button id="bulkTransferBtn" class="btn btn-primary px-4" disabled>
                                <i class="fas fa-exchange-alt me-2"></i> نقل الأصول
                                <span class="badge bg-white text-primary ms-2 bulk-badge">0</span>
                            </button>
                            <button id="bulkDisposeBtn" class="btn btn-warning px-4" disabled>
                                <i class="fas fa-trash-alt me-2"></i> تكهين الأصول
                                <span class="badge bg-white text-warning ms-2 bulk-badge">0</span>
                            </button>
                            <button id="bulkReturnBtn" class="btn btn-info px-4" disabled>
                                <i class="fas fa-undo-alt me-2"></i> إنشاء مستند إرجاع
                                <span class="badge bg-white text-info ms-2 bulk-badge">0</span>
                            </button>
                            <button id="clearSelectionBtn" class="btn btn-outline-secondary px-4" disabled>
                                <i class="fas fa-eraser me-2"></i> مسح التحديد
                            </button>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="selection-counter text-center p-3 rounded-3 shadow-sm">
                            <div class="counter-value">
                                <span id="selectedCount" class="display-6">0</span>
                                <small class="d-block text-muted">أصول محددة</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-clipboard-list me-2"></i> اختيار سريع للأصول
                            <small class="text-muted">(الصق قائمة من Asset Tags)</small>
                        </label>
                        <div class="input-group">
                            <textarea id="bulkAssetTags" class="form-control font-monospace" rows="3"
                                      placeholder="مثال: AST001, AST002, AST003"></textarea>
                            <button id="processAssetTags" class="btn btn-primary">
                                <i class="fas fa-check-circle me-1"></i> تحديد
                            </button>
                        </div>
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i> يمكنك لصق بيانات من Excel مباشرة (سطر لكل أصل)
                        </small>
                    </div>
                </div>
            </div>
            
            <!-- Search Assets Tab -->
            <div class="tab-pane fade" id="search-assets" role="tabpanel">
                <form id="advancedSearchForm" class="needs-validation" novalidate>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="form-floating">
                                <input type="text" id="searchAssetTag" class="form-control" placeholder=" ">
                                <label for="searchAssetTag">Asset Tag</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-floating">
                                <input type="text" id="searchDescription" class="form-control" placeholder=" ">
                                <label for="searchDescription">وصف الأصل</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-floating">
                                <select id="searchDepartment" class="form-select">
                                    <option value="">جميع الأقسام</option>
                                </select>
                                <label for="searchDepartment">القسم</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-floating">
                                <select id="searchStatus" class="form-select">
                                    <option value="">جميع الحالات</option>
                                    <option value="Available">متاح</option>
                                    <option value="In Use">قيد الاستخدام</option>
                                    <option value="Under Maintenance">قيد الصيانة</option>
                                    <option value="Disposed">تم التكهين</option>
                                </select>
                                <label for="searchStatus">الحالة</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-floating">
                                <input type="text" id="searchSerialNumber" class="form-control" placeholder=" ">
                                <label for="searchSerialNumber">الرقم التسلسلي</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-floating">
                                <input type="text" id="searchUser" class="form-control" placeholder=" ">
                                <label for="searchUser">المستلم</label>
                            </div>
                        </div>
                    </div>
                    <div class="text-center mt-4">
                        <button type="submit" class="btn btn-primary px-5 py-2 rounded-pill">
                            <i class="fas fa-search me-2"></i> بحث
                        </button>
                        <button type="reset" class="btn btn-outline-secondary px-5 py-2 rounded-pill">
                            <i class="fas fa-redo me-2"></i> إعادة تعيين
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- Asset Tags Tab -->
            <div class="tab-pane fade" id="asset-tags" role="tabpanel">
                <div class="row">
                    <div class="col-md-8">
                        <div class="form-group">
                            <label class="form-label fw-bold">
                                <i class="fas fa-tags me-2"></i> أدخل Asset Tags للبحث
                            </label>
                            <textarea id="assetTagsInput" class="form-control font-monospace"
                                      rows="5"
                                      placeholder="مثال:
AST001
AST002, AST003
AST004⟶AST005"></textarea>
                            <div class="d-flex justify-content-between mt-2">
                                <span id="tagCounter" class="text-muted">
                                    <i class="fas fa-tag me-1"></i> تم اكتشاف <span class="badge bg-secondary">0</span> tags
                                </span>
                                <button id="clearTagsBtn" class="btn btn-sm btn-outline-secondary">
                                    <i class="fas fa-eraser me-1"></i> مسح
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-flex flex-column h-100 justify-content-center">
                            <div class="text-center mb-4">
                                <div class="search-animation mb-3">
                                    <i class="fas fa-search-plus fa-3x text-primary"></i>
                                </div>
                                <p class="text-muted">البحث عن أصول محددة باستخدام Asset Tags</p>
                            </div>
                            <button id="filterAssets" class="btn btn-primary btn-lg mb-2 rounded-pill shadow">
                                <i class="fas fa-filter me-2"></i> تصفية في الجدول
                            </button>
                            <button id="filterNewPage" class="btn btn-success btn-lg mb-2 rounded-pill shadow">
                                <i class="fas fa-external-link-alt me-2"></i> فتح في صفحة منفصلة
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filtered Results Section (Initially Hidden) -->
<div id="filterResultsSection" class="card shadow-lg border-0 rounded-4 mb-4" style="display: none;">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center py-3 rounded-top-4">
        <h5 class="mb-0"><i class="fas fa-filter me-2"></i> الأصول المصفاة</h5>
        <div>
            <span class="badge bg-light text-primary me-2" id="filterCount">0</span>
            <button type="button" id="closeFilterResults" class="btn btn-sm btn-light">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
    <div class="card-body">
        <div id="filterStats" class="alert alert-light border-start border-info border-4 mb-4">
            <div class="d-flex align-items-center">
                <i class="fas fa-info-circle text-info fa-2x me-3"></i>
                <div>
                    <h6 class="mb-1 fw-bold">نتائج التصفية</h6>
                    <p class="mb-0">عرض الأصول المصفاة حسب Asset Tags</p>
                </div>
            </div>
        </div>

        <div class="table-responsive">
            <table id="filteredAssetsTable" class="table table-striped table-hover align-middle">
                <thead class="table-dark text-center">
                    <tr>
                        <th>Asset Tag <i class="fas fa-tag ms-1"></i></th>
                        <th>الوصف <i class="fas fa-align-left ms-1"></i></th>
                        <th>القسم <i class="fas fa-building ms-1"></i></th>
                        <th>الماركة <i class="fas fa-copyright ms-1"></i></th>
                        <th>الموديل <i class="fas fa-info-circle ms-1"></i></th>
                        <th>الحالة <i class="fas fa-tasks ms-1"></i></th>
                        <th>العمليات <i class="fas fa-cogs ms-1"></i></th>
                    </tr>
                </thead>
                <tbody>
                    <!-- سيتم إدراج النتائج المصفاة هنا -->
                </tbody>
            </table>
        </div>

        <div id="filterTags" class="mt-4">
            <h6 class="fw-bold"><i class="fas fa-filter me-2"></i> تم التصفية حسب:</h6>
            <div id="matchedTags" class="d-flex flex-wrap gap-2 mb-2">
                <!-- سيتم إدراج الTags المطابقة هنا -->
            </div>
            <div id="missingTagsAlert" class="alert alert-warning border-warning mt-3" style="display: none;">
                <div class="d-flex">
                    <div class="me-3">
                        <i class="fas fa-exclamation-triangle fa-2x text-warning"></i>
                    </div>
                    <div>
                        <h6 class="fw-bold">تنبيه!</h6>
                        <p class="mb-2">لم يتم العثور على الTags التالية في قاعدة البيانات:</p>
                        <div id="missingTags" class="d-flex flex-wrap gap-2">
                            <!-- سيتم إدراج الTags المفقودة هنا -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main Assets Table -->
<div class="card shadow-lg border-0 rounded-4">
    <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
        <h4 class="text-primary mb-0"><i class="fas fa-box-open me-2"></i> قائمة الأصول</h4>
        <div class="table-tools">
            <div class="btn-group">
                <button type="button" class="btn btn-outline-primary" id="refreshTable">
                    <i class="fas fa-sync-alt"></i>
                </button>
               
            </div>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table id="assetsTable" class="table table-hover align-middle border-top">
                <thead class="thead-light">
                    <tr>
                        <th width="40px"><input type="checkbox" id="selectAll" class="form-check-input"></th>
                        <th width="120px">العمليات</th>
                        <th>Asset Tag <i class="fas fa-tag text-muted ms-1"></i></th>
                        <th>المنشأة <i class="fas fa-hospital text-muted ms-1"></i></th>
                        <th>المبنى <i class="fas fa-building text-muted ms-1"></i></th>
                        <th>القسم <i class="fas fa-sitemap text-muted ms-1"></i></th>
                        <th>الوصف <i class="fas fa-align-left text-muted ms-1"></i></th>
                        <th>الماركة <i class="fas fa-copyright text-muted ms-1"></i></th>
                        <th>الموديل <i class="fas fa-info text-muted ms-1"></i></th>
                        <th>المستلم <i class="fas fa-user text-muted ms-1"></i></th>
                        <th>الحالة <i class="fas fa-circle text-muted ms-1"></i></th>
                        <th>تاريخ الإدخال <i class="fas fa-calendar text-muted ms-1"></i></th>
                    </tr>
                </thead>
                <tbody>
                    <!-- يتم تحميل البيانات بشكل ديناميكي -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Import Modal -->
<div class="modal fade" id="importModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-file-import me-2"></i> استيراد أصول</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <div class="import-icon-container mb-3">
                        <i class="fas fa-file-excel fa-4x text-success"></i>
                        <i class="fas fa-arrow-right fa-2x text-primary mx-3"></i>
                        <i class="fas fa-database fa-4x text-primary"></i>
                    </div>
                    <h5>استيراد أصول من ملف Excel</h5>
                    <p class="text-muted">قم بتحميل ملف Excel يحتوي على بيانات الأصول</p>
                </div>
                
                @using (Html.BeginForm("ImportAssets", "Asset", FormMethod.Post, new { enctype = "multipart/form-data", id = "importForm" }))
                {
                    <div class="mb-3">
                        <div class="custom-file-upload">
                            <div class="input-group">
                                <input type="file" name="file" id="importFile" class="form-control" accept=".xlsx,.xls" required />
                                <label for="importFile" class="input-group-text">
                                    <i class="fas fa-upload"></i>
                                </label>
                            </div>
                            <small class="form-text text-muted">الملفات المدعومة: .xlsx, .xls</small>
                        </div>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <span>تأكد من أن الملف يحتوي على الأعمدة الصحيحة المطابقة لنموذج النظام</span>
                    </div>
                    <a href="#" id="downloadTemplate" class="btn btn-outline-primary btn-sm mb-3">
                        <i class="fas fa-download me-1"></i> تنزيل نموذج للاستيراد
                    </a>
                }
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i> إلغاء
                </button>
                <button type="submit" form="importForm" class="btn btn-primary">
                    <i class="fas fa-file-import me-1"></i> استيراد
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Transfer Modal -->
<div class="modal fade" id="bulkTransferModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exchange-alt me-2"></i> نقل الأصول المجمعة
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="bulkTransferForm">
                <div class="modal-body">
                    
                    
                    <div class="mb-4">
                        <label class="form-label fw-bold">القسم الهدف</label>
                        <select id="targetDepartment" class="form-select form-select-lg mb-3" required>
                            <option value="">-- اختر القسم --</option>
                        </select>
                        <div class="invalid-feedback">يرجى اختيار القسم الهدف</div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="form-label fw-bold">المستلم الهدف (اختياري)</label>
                        <select id="targetUser" class="form-select form-select-lg">
                            <option value="">-- غير محدد --</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i> إلغاء
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-check me-1"></i> تأكيد النقل
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Bulk Disposal Modal -->
<div class="modal fade" id="bulkDisposalModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-warning text-white">
                <h5 class="modal-title">
                    <i class="fas fa-trash-alt me-2"></i> التكهين من الأصول المجمعة
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="bulkDisposalForm">
                <div class="modal-body">
                    
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">نوع التكهين</label>
                            <input type="text" id="disposalType" class="form-control" required placeholder="-- ادخل النوع --">
                            <div class="invalid-feedback">يرجى ادخال نوع التكهين</div>
                        </div>
                        <div class="col-md-6">
                           <label class="form-label fw-bold">قيمة البيع (ريال)</label>
                            <div class="input-group">
                                <span class="input-group-text">ر.س</span>
                                <input type="number" id="saleValue" class="form-control" value="0" min="0" step="0.01" />
                            </div>
                            <small class="form-text text-muted">أدخل 0 إذا لم يكن هناك قيمة بيع</small>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">سبب التكهين</label>
                        <textarea id="disposalReason" class="form-control" rows="3" 
                                  placeholder="أدخل سبب التكهين بالتفصيل"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">ملاحظات إضافية</label>
                        <textarea id="disposalNotes" class="form-control" rows="2"
                                  placeholder="أي ملاحظات إضافية (اختياري)"></textarea>
                    </div>
                    
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="generateDocument" checked>
                        <label class="form-check-label" for="generateDocument">إنشاء وتنزيل مستند التكهين تلقائياً</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i> إلغاء
                    </button>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-trash-alt me-1"></i> تأكيد التكهين
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.25/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.2.3/css/buttons.bootstrap5.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.25/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.2.3/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.2.3/js/buttons.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.2.3/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.2.3/js/buttons.print.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* Custom Styles */
        .zoom-on-hover {
            transition: transform 0.3s ease;
        }
        
        .zoom-on-hover:hover {
            transform: scale(1.03);
        }
        
        .icon-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(255, 255, 255, 0.9);
        }
        
        .selection-counter {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 10px;
        }
        
        .bg-gradient-primary {
            background: linear-gradient(135deg, #4e73df 0%, #224abe 100%);
        }
        
        .bg-gradient-success {
            background: linear-gradient(135deg, #1cc88a 0%, #13855c 100%);
        }
        
        .bg-gradient-warning {
            background: linear-gradient(135deg, #f6c23e 0%, #dda20a 100%);
        }
        
        .bg-gradient-danger {
            background: linear-gradient(135deg, #e74a3b 0%, #be2617 100%);
        }
        
        .quick-actions .btn {
            margin-right: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .search-animation i {
            animation: pulse 2s infinite;
        }
        
        @@keyframes pulse {
            0% { transform: scale(0.95); opacity: 0.7; }
            50% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(0.95); opacity: 0.7; }
        }
        
        .custom-file-upload {
            border: 2px dashed #ddd;
            border-radius: 5px;
            padding: 15px;
            transition: all 0.3s;
        }
        
        .custom-file-upload:hover {
            border-color: #4e73df;
            background-color: rgba(78, 115, 223, 0.05);
        }
        
        .import-icon-container {
            animation: fadeInUp 1s ease;
        }
        
        @@keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .table-tools .btn {
            padding: 0.375rem 0.75rem;
        }
        
        .nav-tabs .nav-link {
            border: none;
            color: #5a5c69;
            font-weight: 600;
            position: relative;
        }
        
        .nav-tabs .nav-link.active {
            color: #4e73df;
            border-bottom: 3px solid #4e73df;
            background-color: transparent;
        }
        
        .nav-tabs .nav-link:hover {
            border-color: transparent;
            color: #4e73df;
        }
        
        .bulk-badge {
            transition: all 0.3s ease;
        }
        
        /* Table Status Colors */
        .status-available {
            color: #1cc88a;
        }
        
        .status-inuse {
            color: #4e73df;
        }
        
        .status-maintenance {
            color: #f6c23e;
        }
        
        .status-disposed {
            color: #e74a3b;
        }
        
        /* Loading overlay */
        .downloading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }

        .downloading-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-width: 400px;
            width: 100%;
        }

        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
    </style>

    <script>
        $(document).ready(function () {
            // Initialize Dashboard Stats
            fetchAssetStats();
            
            // Initialize the main assets DataTable
            let table = $('#assetsTable').DataTable({
                processing: true,
                serverSide: true,
                ajax: {
                    url: '@Url.Action("GetAssets", "Asset")',
                    type: 'POST'
                },
                scrollX: true,
                order: [[2, 'asc']], // Sort by Asset Tag by default
                language: {
                    url: "//cdn.datatables.net/plug-ins/1.10.25/i18n/Arabic.json"
                },
                dom: '<"d-flex justify-content-between align-items-center mb-3"<"d-flex align-items-center"l><"d-flex"f>>rt<"d-flex justify-content-between align-items-center"<"d-flex align-items-center"i><"d-flex"p>>',
                columns: [
                    {
                        data: null,
                        orderable: false,
                        className: "text-center",
                        render: function () {
                            return `<input type="checkbox" class="row-checkbox form-check-input">`;
                        }
                    },
                    {
                        data: null,
                        orderable: false,
                        className: "text-center",
                        render: function (data, type, row) {
                            return `
                                <div class="btn-group">
                                    <button type="button" class="btn btn-sm btn-primary dropdown-toggle" data-bs-toggle="dropdown">
                                        <i class="fas fa-cog"></i>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a href="/Asset/Edit/${row.assetTag}" class="dropdown-item">
                                            <i class="fas fa-edit text-warning me-2"></i> تعديل
                                        </a></li>
                                        <li><a href="/Asset/Details/${row.assetTag}" class="dropdown-item">
                                            <i class="fas fa-info-circle text-info me-2"></i> التفاصيل
                                        </a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a href="#" class="dropdown-item dispose-btn" data-asset-tag="${row.assetTag}">
                                            <i class="fas fa-trash-alt text-danger me-2"></i> تكهين
                                        </a></li>
                                    </ul>
                                </div>`;
                        }
                    },
                    { 
                        data: 'assetTag',
                        render: function(data) {
                            return `<span class="badge bg-light text-dark p-2 fw-normal">${data}</span>`;
                        }
                    },
                    { data: 'facility.name' },
                    { data: 'building.name' },
                    { data: 'department.name' },
                    { data: 'assetDescription' },
                    { data: 'brand' },
                    { data: 'model' },
                    { 
                        data: 'user.fullName',
                        render: function(data) {
                            return data || '<span class="text-muted">غير محدد</span>';
                        }
                    },
                    { 
                        data: 'status',
                        render: function(data) {
                            let statusClass = '';
                            switch(data) {
                                case 'Available': statusClass = 'status-available'; data="متاح"; break;
                                case 'In Use': statusClass = 'status-inuse'; break;
                                case 'Under Maintenance': statusClass = 'status-maintenance'; break;
                                case 'Disposed': statusClass = 'status-disposed'; data="مكهن"; break;
                            }
                            return `<span class="${statusClass}"><i class="fas fa-circle me-1"></i>${data}</span>`;
                        }
                    },
                    { 
                        data: 'insertDate',
                        render: function(data) {
                            return new Date(data).toLocaleDateString('ar-SA');
                        }
                    }
                ],
                initComplete: function() {
                    $('#assetsTable_filter input').addClass('form-control-sm');
                    $('#assetsTable_length select').addClass('form-select-sm');
                }
            });

            // Initialize the filtered assets table
              let filteredTable = $('#filteredAssetsTable').DataTable({
            responsive: true,
            dom: '<"row"<"col-12 text-center export-btn-container my-2"B>><"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>rtip',
            language: {
                url: "//cdn.datatables.net/plug-ins/1.10.25/i18n/Arabic.json"
            },
            buttons: [
                {
                    extend: 'collection',
                    text: '<i class="fas fa-download mx-1"></i> تصدير',
                    className: 'btn btn-primary export-btn',
                    buttons: [
                        {
                            extend: 'copy',
                            text: '<i class="fas fa-copy mx-1"></i> نسخ',
                            className: 'btn btn-sm'
                        },
                        {
                            extend: 'excel',
                            text: '<i class="fas fa-file-excel mx-1"></i> Excel',
                            className: 'btn btn-sm'
                        },
                        {
                            extend: 'pdf',
                            text: '<i class="fas fa-file-pdf mx-1"></i> PDF',
                            className: 'btn btn-sm'
                        },
                        {
                            extend: 'print',
                            text: '<i class="fas fa-print mx-1"></i> طباعة',
                            className: 'btn btn-sm'
                        }
                    ]
                }
            ]
        });

            // Fetch asset statistics
                  // Fetch asset statistics
        function fetchAssetStats() {
            $.ajax({
                url: '/Asset/GetStats',
                type: 'GET',
                success: function(response) {
                    if (response.success) {
                        $('#totalAssetCount').text(response.totalCount);
                        $('#activeAssetCount').text(response.activeCount);
                        $('#maintenanceAssetCount').text(response.maintenanceCount);
                        $('#disposedAssetCount').text(response.disposedCount);

                        console.log('Asset stats loaded successfully:', response);
                    } else {
                        console.error('Failed to load asset stats:', response.error);
                        // Set default values if stats loading fails
                        $('#totalAssetCount, #activeAssetCount, #maintenanceAssetCount, #disposedAssetCount').text('--');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error fetching asset stats:', error);
                    // Set default values if stats loading fails
                    $('#totalAssetCount, #activeAssetCount, #maintenanceAssetCount, #disposedAssetCount').text('--');
                }
            });
        }

            // Update tag counter as user types
            $('#assetTagsInput').on('input', function () {
                const tags = processAssetTags($(this).val());
                const badge = $(this).closest('.form-group').find('.badge');
                badge.text(tags.length);
                
                if (tags.length > 0) {
                    badge.removeClass('bg-secondary').addClass('bg-primary');
                } else {
                    badge.removeClass('bg-primary').addClass('bg-secondary');
                }
            });

            // Clear tags button
            $('#clearTagsBtn').click(function() {
                $('#assetTagsInput').val('').trigger('input');
            });

            // Handle clipboard paste for Excel data
            $('#assetTagsInput, #bulkAssetTags').on('paste', function (e) {
                setTimeout(() => {
                    let input = $(this).val();
                    if (input.includes('\t')) {
                        input = input.replace(/\t/g, '\n');
                        $(this).val(input);
                        $(this).trigger('input');
                    }
                }, 0);
            });

            // Function to process and clean asset tags
            function processAssetTags(input) {
                return input.split(/[\n,\t]+/)
                    .map(tag => tag.trim())
                    .filter(tag => tag.length > 0)
                    .filter((tag, index, self) => self.indexOf(tag) === index); // Remove duplicates
            }

            // Handle the filter button click
            $('#filterAssets').click(function () {
                const tagsInput = $('#assetTagsInput').val();
                const tags = processAssetTags(tagsInput);

                if (tags.length === 0) {
                    Swal.fire({
                        title: 'خطأ!',
                        text: 'الرجاء إدخال Asset Tag واحد على الأقل',
                        icon: 'error',
                        confirmButtonText: 'حسناً'
                    });
                    return;
                }

                // Show loading indicator
                const loadingOverlay = showLoadingOverlay("جاري تصفية الأصول...");

                // Call the API to get filtered assets
                $.ajax({
                    url: '/Asset/GetFilteredAssets',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(tags),
                    success: function (response) {
                        loadingOverlay.remove();

                        if (response.success) {
                            // Show the filter results section
                            $('#filterResultsSection').fadeIn(300);
                            
                            // Update filter stats
                            $('#filterCount').text(response.data.length);
                            
                            // Clear and reload the filtered table
                            filteredTable.clear().draw();
                            filteredTable.rows.add(response.data.map(asset => [
                                asset.assetTag,
                                asset.assetDescription || 'غير محدد',
                                asset.department?.name || 'غير محدد',
                                asset.brand || 'غير محدد',
                                asset.model || 'غير محدد',
                                asset.status || 'غير محدد',
                                `<div class="btn-group">
                                    <a href="/Asset/Edit/${asset.assetTag}" class="btn btn-sm btn-primary" title="تعديل">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <a href="/Asset/Details/${asset.assetTag}" class="btn btn-sm btn-info" title="تفاصيل">
                                        <i class="fas fa-info-circle"></i>
                                    </a>
                                    <a href="#" class="btn btn-sm btn-danger dispose-btn" title="تكهين" data-asset-tag="${asset.assetTag}">
                                        <i class="fas fa-trash-alt"></i>
                                    </a>
                                </div>`
                            ])).draw();

                            // Display matched and missing tags
                            $('#matchedTags').empty();
                            $('#missingTags').empty();

                            // Get the list of found asset tags
                            const foundTags = response.data.map(a => a.assetTag);

                            // Display matched tags
                            foundTags.forEach(tag => {
                                $('#matchedTags').append(`
                                    <span class="badge bg-primary p-2 me-1">${tag}</span>
                                `);
                            });

                            // Check for missing tags
                            const missingTags = tags.filter(tag => !foundTags.includes(tag));
                            if (missingTags.length > 0) {
                                $('#missingTagsAlert').show();
                                $('#missingTags').empty();
                                missingTags.forEach(tag => {
                                    $('#missingTags').append(`
                                        <span class="badge bg-warning text-dark p-2 me-1">${tag}</span>
                                    `);
                                });
                            } else {
                                $('#missingTagsAlert').hide();
                            }
                            
                            // Scroll to results
                            $('html, body').animate({
                                scrollTop: $("#filterResultsSection").offset().top - 20
                            }, 500);
                        } else {
                            Swal.fire({
                                title: 'خطأ!',
                                text: response.error || 'حدث خطأ أثناء تصفية الأصول',
                                icon: 'error',
                                confirmButtonText: 'حسناً'
                            });
                        }
                    },
                    error: function (xhr) {
                        loadingOverlay.remove();
                        Swal.fire({
                            title: 'خطأ!',
                            text: 'حدث خطأ أثناء تصفية الأصول: ' + (xhr.responseJSON?.error || 'خطأ غير معروف'),
                            icon: 'error',
                            confirmButtonText: 'حسناً'
                        });
                    }
                });
            });

            // Show loading overlay
            function showLoadingOverlay(message) {
                const overlay = $(`
                    <div class="downloading-overlay">
                        <div class="downloading-content">
                            <div class="spinner-border text-primary mb-3" role="status"></div>
                            <h5>${message}</h5>
                            <p class="text-muted mb-0">يرجى الانتظار...</p>
                        </div>
                    </div>
                `);
                $('body').append(overlay);
                return overlay;
            }

            // Close filter results
            $('#closeFilterResults').click(function () {
                $('#filterResultsSection').fadeOut(300);
            });

            // Handle checkbox selection and bulk operations
            let selectedAssets = new Set();
            
            $(document).on('change', '.row-checkbox', function () {
                const row = $(this).closest('tr');
                const assetTag = table.row(row).data().assetTag;

                if (this.checked) {
                    selectedAssets.add(assetTag);
                } else {
                    selectedAssets.delete(assetTag);
                }

                updateBulkControls();
            });

            // "Select All" checkbox
            $('#selectAll').on('change', function () {
                $('.row-checkbox').prop('checked', this.checked);

                if (this.checked) {
                    table.rows().data().each(function (row) {
                        selectedAssets.add(row.assetTag);
                    });
                } else {
                    selectedAssets.clear();
                }

                updateBulkControls();
            });

            // Process bulk asset tags from textarea
            $('#processAssetTags').click(function () {
                const tags = processAssetTags($('#bulkAssetTags').val());

                if (tags.length === 0) {
                    Swal.fire({
                        title: 'تنبيه!',
                        text: 'الرجاء إدخال Asset Tag واحد على الأقل',
                        icon: 'warning',
                        confirmButtonText: 'حسناً'
                    });
                    return;
                }

                // Clear existing selections
                $('.row-checkbox').prop('checked', false);
                selectedAssets.clear();

                // Search and select matching rows
                let found = 0;
                table.rows().every(function () {
                    const rowData = this.data();
                    if (tags.includes(rowData.assetTag)) {
                        found++;
                        selectedAssets.add(rowData.assetTag);
                        $(this.node()).find('.row-checkbox').prop('checked', true);
                    }
                });

                // Show results feedback
                const notFound = tags.length - found;
                
                if (found > 0) {
                    Swal.fire({
                        icon: notFound > 0 ? 'info' : 'success',
                        title: 'تم تحديد الأصول',
                        html: `
                            <p>✅ تم العثور وتحديد ${found} أصل</p>
                            ${notFound > 0 ? `<p>⚠️ ${notFound} أصل غير موجود في العرض الحالي</p>` : ''}
                        `,
                        confirmButtonText: 'حسناً'
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'لم يتم العثور على أي أصول',
                        text: 'لم يتم العثور على أي من الأصول المدخلة في العرض الحالي',
                        confirmButtonText: 'حسناً'
                    });
                }

                // Update bulk operation controls
                updateBulkControls();

                // Clear the textarea
                $('#bulkAssetTags').val('');
            });

            // Clear Selection Button
            $('#clearSelectionBtn').click(function() {
                selectedAssets.clear();
                $('.row-checkbox').prop('checked', false);
                $('#selectAll').prop('checked', false);
                updateBulkControls();
            });

            // Update bulk controls
            function updateBulkControls() {
                const count = selectedAssets.size;
                $('#selectedCount').text(count);
                $('.bulk-badge').text(count);
                
                $('#bulkTransferBtn, #bulkDisposeBtn, #bulkReturnBtn, #clearSelectionBtn').prop('disabled', count === 0);
                
                if (count > 0) {
                    $('.selection-counter').addClass('animate__animated animate__pulse');
                    setTimeout(() => {
                        $('.selection-counter').removeClass('animate__animated animate__pulse');
                    }, 1000);
                }
            }

            // Handle bulk transfer button click
            $('#bulkTransferBtn').click(function () {
                loadDepartmentsAndUsers();
                $('#bulkTransferModal').modal('show');
            });

            // Handle bulk dispose button click
            $('#bulkDisposeBtn').click(function () {
                $('#bulkDisposalModal').modal('show');
            });

            // Function to load departments and users
            function loadDepartmentsAndUsers() {
                const departmentSelect = $('#targetDepartment');
                const userSelect = $('#targetUser');

                // Show loading indicators
                departmentSelect.prop('disabled', true).html('<option>جاري تحميل الأقسام...</option>');
                userSelect.prop('disabled', true).html('<option>جاري تحميل المستلمين...</option>');

                // Load departments
                $.get('/Asset/GetDepartments')
                    .done(function (departments) {
                        departmentSelect.prop('disabled', false)
                            .empty()
                            .append('<option value="">-- اختر القسم --</option>');

                        departments.forEach(dept => {
                            departmentSelect.append(
                                `<option value="${dept.id}">${dept.name}</option>`
                            );
                        });
                    })
                    .fail(function (error) {
                        console.error('Failed to load departments:', error);
                        departmentSelect.prop('disabled', false)
                            .empty()
                            .append('<option value="">خطأ في تحميل الأقسام</option>');
                    });

                // Load users
                $.get('/Asset/GetUsers')
                    .done(function (response) {
                        userSelect.prop('disabled', false).empty();
                        userSelect.append(`<option value="">-- غير محدد --</option>`);

                        if (response.success && Array.isArray(response.data)) {
                            if (response.data.length === 0) {
                                userSelect.append(`<option disabled>لا يوجد مستخدمين في النظام</option>`);
                            } else {
                                response.data.forEach(user => {
                                    userSelect.append(`<option value="${user.id}">${user.name}</option>`);
                                });
                            }
                        } else {
                            userSelect.append(`<option disabled>خطأ: تنسيق بيانات غير صالح</option>`);
                        }
                    })
                    .fail(function (xhr) {
                        userSelect.prop('disabled', false)
                            .empty()
                            .append(`<option disabled>خطأ في تحميل المستلمين</option>`);
                    });
            }

            // Bulk transfer form submission
            $('#bulkTransferForm').on('submit', function (e) {
                e.preventDefault();

                const targetDepartmentId = parseInt($('#targetDepartment').val());
                const targetUserId = $('#targetUser').val();

                if (!targetDepartmentId) {
                    Swal.fire({
                        title: 'خطأ!',
                        text: 'الرجاء اختيار القسم الهدف',
                        icon: 'error',
                        confirmButtonText: 'حسناً'
                    });
                    return;
                }

                const request = {
                    assetTags: Array.from(selectedAssets),
                    targetDepartmentId: targetDepartmentId,
                    targetUserId: targetUserId || null
                };

                // Show loading overlay
                const loadingOverlay = showLoadingOverlay("جاري نقل الأصول...");

                $.ajax({
                    url: '/Asset/BulkTransfer',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(request),
                    success: function (response) {
                        loadingOverlay.remove();
                        
                        $('#bulkTransferModal').modal('hide');
                        selectedAssets.clear();
                        updateBulkControls();
                        table.ajax.reload();
                        
                        Swal.fire({
                            title: 'تم بنجاح!',
                            text: 'تم نقل الأصول بنجاح',
                            icon: 'success',
                            confirmButtonText: 'حسناً'
                        });
                    },
                    error: function (xhr, status, error) {
                        loadingOverlay.remove();
                        
                        Swal.fire({
                            title: 'خطأ!',
                            text: 'فشل نقل الأصول: ' + (xhr.responseJSON?.error || 'خطأ غير معروف'),
                            icon: 'error',
                            confirmButtonText: 'حسناً'
                        });
                    }
                });
            });

            // Bulk disposal form submission
            $('#bulkDisposalForm').on('submit', function (e) {
                e.preventDefault();

                const request = {
                    assetTags: Array.from(selectedAssets),
                    disposalType: $('#disposalType').val(),
                    saleValue: parseFloat($('#saleValue').val()) || 0
                };

                if (!request.disposalType) {
                    Swal.fire({
                        title: 'خطأ!',
                        text: 'الرجاء اختيار نوع التكهين',
                        icon: 'error',
                        confirmButtonText: 'حسناً'
                    });
                    return;
                }

                // Show confirmation dialog
                Swal.fire({
                    title: 'تأكيد التكهين',
                    html: `هل أنت متأكد من رغبتك في تكهين <strong>${request.assetTags.length}</strong> أصول؟<br>هذه العملية لا يمكن التراجع عنها.`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'نعم، قم بالتكهين',
                    cancelButtonText: 'إلغاء'
                }).then((result) => {
                         if (result.isConfirmed) {
                            // Show loading overlay
                            const loadingOverlay = showLoadingOverlay("جاري تكهين الأصول وإنشاء المستند...");

                            // Send the request
                            $.ajax({
                                url: '/Asset/BulkDispose',
                                type: 'POST',
                                contentType: 'application/json',
                                data: JSON.stringify(request),
                                xhrFields: {
                                    responseType: 'blob' // Expect binary data (PDF) in response
                                },
                                success: function (blob) {
                                    loadingOverlay.remove();

                                    // Handle PDF download
                                    const url = window.URL.createObjectURL(blob);
                                    const a = document.createElement('a');
                                    a.href = url;
                                    a.download = `مستند_التكهين_${new Date().toISOString().slice(0,10)}.pdf`;
                                    document.body.appendChild(a);
                                    a.click();
                                    window.URL.revokeObjectURL(url);

                                    // Clean up and update UI
                                    $('#bulkDisposalModal').modal('hide');
                                    selectedAssets.clear();
                                    updateBulkControls();
                                    table.ajax.reload();

                                    // Show success message
                                    Swal.fire({
                                        title: 'تم بنجاح!',
                                        html: `تم تكهين الأصول بنجاح.<br>جاري تنزيل مستند التكهين...`,
                                        icon: 'success',
                                        confirmButtonText: 'حسناً'
                                    });

                                    // Refresh asset stats
                                    fetchAssetStats();
                                },
                                error: function (xhr) {
                                    loadingOverlay.remove();

                                    // Try to parse error message
                                    let errorMessage = 'حدث خطأ أثناء تنفيذ عملية التكهين';
                                    if (xhr.responseType !== 'blob') {
                                        try {
                                            const errorResponse = JSON.parse(xhr.responseText);
                                            errorMessage = errorResponse.error || errorMessage;
                                        } catch (e) {
                                            console.error('Error parsing error response:', e);
                                        }
                                    }

                                    Swal.fire({
                                        title: 'خطأ!',
                                        text: errorMessage,
                                        icon: 'error',
                                        confirmButtonText: 'حسناً'
                                    });
                                }
                            });
                        }
                    });
                });

                // Handle individual dispose button click
                $(document).on('click', '.dispose-btn', function () {
                    const assetTag = $(this).data('asset-tag');
                    selectedAssets.clear();
                    selectedAssets.add(assetTag);
                    updateBulkControls();

                    // Trigger the bulk disposal modal
                    $('#bulkDisposalModal').modal('show');
                });

                // Handle the Open in New Page button
                $('#filterNewPage').click(function() {
                    const tagsInput = $('#assetTagsInput').val();
                    const tags = processAssetTags(tagsInput);

                    if (tags.length === 0) {
                        Swal.fire({
                            title: 'خطأ!',
                            text: 'الرجاء إدخال Asset Tag واحد على الأقل',
                            icon: 'error',
                            confirmButtonText: 'حسناً'
                        });
                        return;
                    }

                    // Create a form to submit to the new page
                    const form = $('<form></form>').attr({
                        id: 'newPageForm',
                        action: '/Asset/FilteredAssets',
                        method: 'post'
                    });

                    // Add inputs for each tag
                    tags.forEach(tag => {
                        form.append(`<input type="hidden" name="assetTags" value="${tag}">`);
                    });

                    // Add form to body and submit
                    $('body').append(form);
                    $('#newPageForm').submit();
                });

                // Return Document Button
                $('#bulkReturnBtn').on('click', function() {
                    if (selectedAssets.size === 0) {
                        Swal.fire({
                            title: 'خطأ!',
                            text: 'الرجاء تحديد أصول أولاً',
                            icon: 'error',
                            confirmButtonText: 'حسناً'
                        });
                        return;
                    }

                    // Redirect to the return document creation page with selected assets
                    const assetTags = Array.from(selectedAssets);

                    // Create a form to submit
                    const form = $('<form></form>').attr({
                        method: 'post',
                        action: '@Url.Action("Create", "ReturnDocument")'
                    });

                    // Add asset tags as hidden inputs
                    assetTags.forEach(tag => {
                        form.append($('<input>').attr({
                            type: 'hidden',
                            name: 'AssetTags',
                            value: tag
                        }));
                    });

                    // Add CSRF token
                    form.append($('<input>').attr({
                        type: 'hidden',
                        name: '__RequestVerificationToken',
                        value: $('input[name="__RequestVerificationToken"]').val()
                    }));

                    // Append form to body and submit
                    $('body').append(form);
                    form.submit();
                });

                // Refresh table button
                $('#refreshTable').click(function() {
                    table.ajax.reload();
                    fetchAssetStats();

                    // Show toast notification
                    Swal.fire({
                        toast: true,
                        position: 'top-end',
                        showConfirmButton: false,
                        timer: 3000,
                        icon: 'success',
                        title: 'تم تحديث البيانات'
                    });
                });

                // Download template button
                $('#downloadTemplate').click(function(e) {
                    e.preventDefault();

                    Swal.fire({
                        title: 'تحميل النموذج',
                        text: 'سيتم تحميل نموذج Excel فارغ لاستيراد الأصول',
                        icon: 'info',
                        showCancelButton: true,
                        confirmButtonText: 'تحميل',
                        cancelButtonText: 'إلغاء'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            // Here you'd typically trigger the actual download
                            // This would be a link to an action on your controller
                            window.location.href = '@Url.Action("DownloadTemplate", "Asset")';
                        }
                    });
                });

                     
            });
        
    </script>

                    }