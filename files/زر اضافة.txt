


Sub جلب_البيانات_وتعبئتها_وحفظ_ك_بي_دي_اف() ' زر اضافة طلب صرف مواد
    Dim srcWs As Worksheet, destWs As Worksheet, inputWs As Worksheet
    Dim tag As String
    Dim srcLastRow As Long, destRow As Long, i As Long, inputRow As Long
    Dim found As Range
    Dim sVal As Range, tVal As Range
    Dim foundInS As Boolean, foundInT As Boolean
    Dim pdfName As String
    Dim folderPath As String
    Dim filePath As String
    
    ' تعيين أوراق العمل
    Set srcWs = ThisWorkbook.Sheets("ALL FA- الاصول")
    Set destWs = ThisWorkbook.Sheets("طلب صرف")
    Set inputWs = ThisWorkbook.Sheets("ادخال البيانات")
    
    ' نقل بيانات الخلية G15 من ورقة "ادخال البيانات" إلى B4 في ورقة "طلب صرف"
  '  destWs.Range("B3").Value = inputWs.Range("G15").Value
 
    
    
    ' مسح البيانات السابقة في النطاق B10 إلى M19
    destWs.Range("B10:M19").ClearContents
    
    ' العثور على آخر صف يحتوي على بيانات في ورقة المصدر
    srcLastRow = srcWs.Cells(srcWs.Rows.Count, "A").End(xlUp).row
    
    ' بدء النسخ من الصف 10 في ورقة طلب صرف
    destRow = 10
    
    ' التحقق من الخلايا في ورقة ادخال البيانات من C3 إلى C12
    For inputRow = 3 To 12
        If inputWs.Cells(inputRow, 3).Value <> "" Then
            tag = inputWs.Cells(inputRow, 3).Value
            
            ' البحث عن Asset Tag في ورقة ALL FA- الاصول
            Set found = srcWs.Range("A1:A" & srcLastRow).Find(What:=tag, LookIn:=xlValues, LookAt:=xlWhole)
            
            If Not found Is Nothing Then
                ' نقل البيانات المحددة إلى ورقة طلب صرف
                destWs.Cells(destRow, 13).Value = srcWs.Cells(found.row, 1).Value ' نقل العمود A إلى العمود M
                destWs.Cells(destRow, 12).Value = srcWs.Cells(found.row, 12).Value ' نقل العمود L إلى العمود L
                destWs.Cells(destRow, 2).Value = srcWs.Cells(found.row, 17).Value ' نقل العمود Q إلى العمود B
                
                ' كتابة 1 في العمود G إذا كانت هناك بيانات في العمود M
                If destWs.Cells(destRow, 13).Value <> "" Then
                    destWs.Cells(destRow, 7).Value = 1
                Else
                    destWs.Cells(destRow, 7).Value = ""
                End If
                
                ' العمود AL إلى الخلية B3
                destWs.Range("B3").Value = srcWs.Cells(found.row, 38).Value
                
                ' العمود AM إلى الخلية H5
                destWs.Range("H5").Value = srcWs.Cells(found.row, 39).Value
                
                ' العمود AT إلى الخلية M21 و B21
                destWs.Range("M21").Value = srcWs.Cells(found.row, 46).Value
                destWs.Range("B21").Value = srcWs.Cells(found.row, 46).Value
                
                ' العمود AW إلى الخلية M22 و B22
                destWs.Range("M22").Value = srcWs.Cells(found.row, 49).Value
                destWs.Range("B22").Value = srcWs.Cells(found.row, 49).Value

                ' العمود H إلى الخلية M5 بعد كلمة "الجهة الطالبة/"
                destWs.Range("M5").Value = "الجهة الطالبة/ " & srcWs.Cells(found.row, 8).Value
                
                ' الانتقال إلى الصف التالي بعد نقل البيانات
                destRow = destRow + 1
            Else
                MsgBox "لم يتم العثور على Asset Tag: " & tag, vbExclamation
            End If
        End If
    Next inputRow
    
    ' التحقق من القيم في L10 إلى L19 ومقارنتها مع العمودين S و T
    foundInS = False
    foundInT = False
    For i = 10 To 19
        Set sVal = destWs.Range("S:S").Find(What:=destWs.Cells(i, 12).Value, LookIn:=xlValues, LookAt:=xlWhole)
        Set tVal = destWs.Range("T:T").Find(What:=destWs.Cells(i, 12).Value, LookIn:=xlValues, LookAt:=xlWhole)
        
        If Not sVal Is Nothing Then
            foundInS = True
            Exit For
        End If
        If Not tVal Is Nothing Then
            foundInT = True
            Exit For
        End If
    Next i
    
    If foundInS Then
        destWs.Range("K21").Value = destWs.Range("Q2").Value
        destWs.Range("F21").Value = destWs.Range("P2").Value
    ElseIf foundInT Then
        destWs.Range("K21").Value = destWs.Range("Q3").Value
        destWs.Range("F21").Value = destWs.Range("P3").Value
    End If
    
    ' تعيين منطقة الطباعة
    destWs.PageSetup.PrintArea = "$A$1:$N$26"
    
    ' الحصول على اسم الملف من الخلية B21 والتاريخ والوقت الحاليين
    pdfName = destWs.Range("B21").Value & " " & Format(Now(), "yyyy-mm-dd_hh_mm_ss") & ".pdf"
    
    ' الحصول على مسار المجلد الحالي وإنشاء مسار مجلد "Exchange request"
    folderPath = ThisWorkbook.Path & "\Exchange request\"
    
    ' التحقق إذا كان المجلد موجود، إذا لم يكن موجودًا، إنشائه
    If Dir(folderPath, vbDirectory) = "" Then
        MkDir folderPath
    End If
    
    ' إنشاء المسار الكامل للملف
    filePath = folderPath & pdfName
    
    ' حفظ الورقة بصيغة PDF
    destWs.ExportAsFixedFormat Type:=xlTypePDF, Filename:=filePath, Quality:=xlQualityStandard, IncludeDocProperties:=True, IgnorePrintAreas:=False, OpenAfterPublish:=False
    
    MsgBox "تم جلب البيانات وحفظ الملف بنجاح في: " & filePath, vbInformation
End Sub
